# create_polygon_from_str <- function(
#   coordinate_str, crs    
# ) {
#   # Check arguments
#   stopifnot(grepl('^\\[\\[-{0,1}\\d', coordinate_str))
#   stopifnot(grepl('\\d\\]\\]$', coordinate_str))
#   # Convert coordinates to a vector of strings
#   coordinate_str_vector <- coordinate_str |>
#     gsub(pattern = '\\s+', replacement = '') |>
#     gsub(pattern = '^\\[+', replacement = '') |>
#     gsub(pattern = '\\]+$', replacement = '') |>
#     strsplit(split = '\\],\\[')
#   # Check first and last coordinates are identical
#   stopifnot(
#     identical(
#       head(coordinate_str_vector[[1]], 1),
#       tail(coordinate_str_vector[[1]], 1)
#     )
#   )
#   # Convert character vector of coordiantes to polygon
#   polygon <- coordinate_str_vector[[1]] |>
#     base::strsplit(split = ',') |>
#     base::lapply(as.numeric) |>
#     base::lapply(sf::st_point) |>
#     sf::st_sfc(crs = crs) |>
#     sf::st_combine() |>
#     sf::st_cast('LINESTRING') |>
#     sf::st_cast('POLYGON') |>
#     sf::st_transform(crs = crs)
#   return(polygon)
# }

create_str_from_polygon <- function(
  polygon
) {
  # Get coordinate str
  point_matrix <- sf::st_coordinates(polygon)[,c('X', 'Y')]
  coordinate_str <- paste0(
    '[[',
    paste(apply(point_matrix, 1, paste, collapse=','), collapse='],['),
    ']]'
  )
  # Get crs
  crs <- as.integer(
    gsub('EPSG:', '', sf::st_crs(polygon)$input)
  )
  # Create and return string
  output <- list(
    'coordinates' = coordinate_str, 
    'crs' = crs
  )
  return(output)
}

# polygon_str_list <- list(
#   doncaster = '[[-1.1405401,53.519307],[-1.1383611,53.5191412],[-1.1375889,53.5186564],[-1.1364305,53.5193134],[-1.135047,53.5189052],[-1.1331164,53.5176039],[-1.1307568,53.5173997],[-1.1288692,53.5186883],[-1.1274213,53.5197855],[-1.1256623,53.5188478],[-1.1244074,53.5200087],[-1.1248901,53.5202447],[-1.1245254,53.5205956],[-1.121651,53.5196451],[-1.1212435,53.5201363],[-1.1258983,53.5214822],[-1.1254585,53.5219542],[-1.1267992,53.5224007],[-1.1242144,53.5247734],[-1.1245361,53.5248818],[-1.1274534,53.5269801],[-1.1292017,53.5263104],[-1.1301777,53.5272543],[-1.1271853,53.5280324],[-1.1270566,53.5292378],[-1.1290837,53.5302964],[-1.1311751,53.5299839],[-1.1313038,53.5310935],[-1.1362285,53.5306854],[-1.138084,53.528989],[-1.1420631,53.529799],[-1.144605,53.5300732],[-1.1484983,53.527822],[-1.1457848,53.5262594],[-1.1455917,53.5260107],[-1.1439079,53.5266867],[-1.142653,53.5257492],[-1.141559,53.5263041],[-1.1403149,53.5254558],[-1.1405401,53.519307]]',
#   north = '[[-1.1466336,53.5221455],[-1.1423421,53.5252198],[-1.1407971,53.5259852],[-1.1401856,53.526151],[-1.138823,53.5250668],[-1.1373854,53.5245055],[-1.1350465,53.525156],[-1.1337376,53.5258959],[-1.1329865,53.5267378],[-1.1317635,53.5269291],[-1.1240602,53.5273755],[-1.1192322,53.5320437],[-1.1283302,53.5419905],[-1.1630917,53.5431126],[-1.174078,53.5283704],[-1.1466336,53.5221455]]',
#   frenchgate = '[[-1.1369348,53.5244481],[-1.1333513,53.5301306],[-1.137042,53.5390832],[-1.1538649,53.5303602],[-1.1491013,53.5207423],[-1.1377877,53.5217405],[-1.1368543,53.5223688],[-1.1366773,53.5223624],[-1.1364949,53.5224932],[-1.1359853,53.5232968],[-1.1355025,53.5238007],[-1.1369348,53.5244481]]',
#   market = '[[-1.1384583,53.5252709],[-1.1370099,53.5238326],[-1.1360121,53.523418],[-1.1355561,53.5238007],[-1.1336464,53.5230513],[-1.1322731,53.522726],[-1.1314577,53.5235966],[-1.1310607,53.5246394],[-1.1311519,53.525915],[-1.131447,53.5267059],[-1.1316991,53.5268685],[-1.1339897,53.5282142],[-1.137321,53.5277327],[-1.1384583,53.5252709]]'
# )
# polygon_list <- lapply(
#   polygon_str_list, create_polygon_from_str, crs = 4326
# )
# polygon_list[['doncaster_north']] <- sf::st_intersection(
#   polygon_list$doncaster,
#   polygon_list$north
# )
# polygon_list[['doncaster_frenchgate']] <- sf::st_difference(
#   sf::st_intersection(
#     polygon_list$doncaster,
#     polygon_list$frenchgate
#   ),
#   polygon_list$doncaster_north,
# )
# polygon_list[['doncaster_market']] <- sf::st_difference(
#   polygon_list$market,
#   sf::st_union(
#     c(
#       polygon_list$doncaster_north,
#       polygon_list$doncaster_frenchgate
#     )
#   )
# )
# polygon_list[['doncaster_south']] <- sf::st_difference(
#   polygon_list$doncaster,
#   x <- sf::st_union(
#     c(
#       polygon_list$north,
#       polygon_list$frenchgate,
#       polygon_list$market
#     )
#   )
# )
# 
# polygon_list_selected <- polygon_list[
#   c('doncaster', 'doncaster_north', 'doncaster_frenchgate', 'doncaster_market', 'doncaster_south')
# ]
# plot(do.call(c, polygon_list_selected))
# 
# # create_str_from_polygon(
# #   polygon_list_selected$doncaster_north
# # )$coordinates
# # 
# # 
# # polygon<- create_polygon_from_str(
# #   coordinate_str_1, 4326
# # )
# # x <- create_str_from_polygon(polygon)
# # 
# # crs <- 4326
# # 
# # x <- sf::st_union(
# #   polygon_list$doncaster_frenchgate,
# #   polygon_list$doncaster_north
# # )
# # plot(x)
# # 
# # watford <- '[[-0.3947353,51.6520909],[-0.394333,51.6520376],[-0.3939199,51.6520576],[-0.3934532,51.6522274],[-0.3929597,51.652457],[-0.3922945,51.6528031],[-0.3917688,51.6531826],[-0.3914791,51.6536185],[-0.3913665,51.6540911],[-0.3913718,51.6546137],[-0.3915435,51.655003],[-0.392139,51.6554124],[-0.3931689,51.6559182],[-0.3944135,51.6566238],[-0.3949285,51.6570364],[-0.3944778,51.6575123],[-0.3956205,51.6579283],[-0.3957546,51.6573759],[-0.397101,51.657682],[-0.3969562,51.6578884],[-0.3969777,51.6583343],[-0.398308,51.658331],[-0.3985977,51.6591662],[-0.3997135,51.6601513],[-0.4018593,51.6607769],[-0.4040909,51.6613492],[-0.4057699,51.6599582],[-0.405153,51.6595722],[-0.4061133,51.6591097],[-0.404563,51.6582078],[-0.4030824,51.6587736],[-0.4021651,51.6577885],[-0.4018056,51.6573093],[-0.4014784,51.6565173],[-0.3999442,51.656667],[-0.399735,51.6563043],[-0.398984,51.6555455],[-0.3976536,51.654374],[-0.3969052,51.6536651],[-0.3960657,51.6530428],[-0.3953362,51.6523372],[-0.3947353,51.6520909]]'
# # watford_polygon <- create_polygon_from_str(watford, 4326)
# 
# x <- '[[-1.1369348,53.5244481],[-1.1355025,53.5238007],[-1.13551714585619,53.5237854142751],[-1.1355171458562,53.5237854142751],[-1.1355171458562,53.5237854142751],[-1.1359853,53.5232968],[-1.1364949,53.5224932],[-1.1366773,53.5223624],[-1.1368543,53.5223688],[-1.1377877,53.5217405],[-1.1404596109026,53.5215048576141],[-1.1405401,53.519307],[-1.1383611,53.5191412],[-1.1375889,53.5186564],[-1.1364305,53.5193134],[-1.135047,53.5189052],[-1.1331164,53.5176039],[-1.1307568,53.5173997],[-1.1288692,53.5186883],[-1.1274213,53.5197855],[-1.1256623,53.5188478],[-1.1244074,53.5200087],[-1.1248901,53.5202447],[-1.1245254,53.5205956],[-1.121651,53.5196451],[-1.1212435,53.5201363],[-1.1258983,53.5214822],[-1.1254585,53.5219542],[-1.1267992,53.5224007],[-1.1242144,53.5247734],[-1.1245361,53.5248818],[-1.1274534,53.5269801],[-1.1292017,53.5263104],[-1.12995013938957,53.5270342281802],[-1.1317635,53.5269291],[-1.13179409977617,53.5269243137978],[-1.13179409977617,53.5269243137978],[-1.1329865,53.5267378],[-1.1337376,53.5258959],[-1.1350465,53.525156],[-1.13679508222603,53.5246696866655],[-1.1369348,53.5244481]]'
